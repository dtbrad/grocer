// debugger
$('#graph_error_explanation').html("")
var graph_change = '<%= (params[:graph_change]).to_s %>'
var graph_valid = '<%= @graph_config.valid?.to_s %>'

if (graph_change === 'yes' && graph_valid == 'true' ) {
  $("#index-title").html("Spending: <%= short_format_date(@graph_config.start_date) %> to <%= short_format_date(@graph_config.end_date) %>")
  $("#outerdan").html("<div id='danielchart'></div>")
  $('#baskets_table').html("<%= escape_javascript render partial: 'baskets', locals: { baskets: @baskets } %>");
  $('#paginator').html('<%= escape_javascript(paginate(@baskets, theme: "twitter-bootstrap-3", :remote => true).to_s) %>');
  var json = '<%= current_user.baskets.group_baskets(@graph_config).to_json %>'
  var data_array = JSON.parse(json.replace(/&quot;/g,'"'));
  var new_array = data_array.map(function(x) {
    return [Date.parse(x[0]), x[1]]
  })
  var unit = '<%= @graph_config.unit %>'

  function right_date(unit) {
    if (unit == 'month') {
      return '%b %Y'
    }
    else if (unit == 'week') {
      return 'week of %b %e, %Y'
    }
    else {
      return '%b %e, %Y'
    }
  }

  var for_graph = right_date(unit)


  Highcharts.chart('danielchart', {

      chart: { renderTo: 'danielchart', type: 'spline' },
      title: {
          text: 'Spending History'
      },
      yAxis: {
        title: {
            text: 'Amount Spent'
        },
        labels: {
        format: '${value}'
        }
      },
      xAxis: {
       type: 'datetime',
       title: {
           text: 'Date'
       }
      },
      series: [{
          name: 'spending',
          data: new_array
      }],
      tooltip: {
                  formatter: function() {
                              return Highcharts.dateFormat(for_graph, new Date(this.x)) + ' - $'  + this.y
                             }
              },
        credits: {
      enabled: false
  },
  });
}
else if (graph_change === 'yes' && graph_valid == 'false') {
  $('#graph_error_explanation').append("<ul> <% @graph_config.errors.full_messages.each do |message| %> <p> <%= message %> </p> <% end %> </ul>")
}
else {
  $('#baskets_table').html("<%= escape_javascript render partial: 'baskets', locals: { baskets: @baskets } %>");
  $('#paginator').html('<%= escape_javascript(paginate(@baskets, theme: "twitter-bootstrap-3", :remote => true).to_s) %>');
};
